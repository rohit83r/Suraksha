generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum TripStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum GeoFenceType {
  POLYGON
  CIRCLE
}

enum AlertType {
  ENTERED_GEOFENCE
  EXITED_GEOFENCE
  SOS
  GPS_LOSS
}

model LocationPing {
  id         String   @id @default(uuid())
  touristId  String
  tourist    Tourist  @relation(fields: [touristId], references: [id])
  tripId     String?  // optional linking to Trip
  deviceId   String?
  lat        Float
  lng        Float
  speed      Float?
  bearing    Float?
  accuracy   Float?
  status     String?    // moving, paused, charging...
  ts         DateTime   // timestamp from device
  receivedAt DateTime   @default(now())

  @@index([touristId, ts])
  @@index([ts])
}


model Tourist {
  id                String             @id @default(uuid())
  name              String
  email             String             @unique
  password          String
  passportNumber    String?
  aadhaarNumber     String?
  trips             Trip[]
  emergencyContacts EmergencyContact[]
  verified          Boolean            @default(false)
  safetyScore       Int                @default(100)
  qrCodeUrl         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // one-to-one latest location
  lastLocation TouristLocation?

  // Added: inverse relation for alerts
  alerts            Alert[]
  
  // Add this line for LocationPing relation
  locationPings     LocationPing[]     // Add this line
}

model Trip {
  id        String     @id @default(uuid())
  startDate DateTime
  endDate   DateTime
  itinerary Json
  status    TripStatus @default(ACTIVE)
  touristId String
  tourist   Tourist    @relation(fields: [touristId], references: [id])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([touristId])
}

model EmergencyContact {
  id        String  @id @default(uuid())
  name      String
  phone     String
  relation  String
  touristId String
  tourist   Tourist @relation(fields: [touristId], references: [id])

  @@index([touristId])
}

model Admin {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String
  role     String @default("tourism_officer")

  // geofences created by this admin
  createdGeoFences GeoFence[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  role      String
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
}

model GeoFence {
  id                String       @id @default(uuid())
  name              String
  description       String?
  type              GeoFenceType
  // coords: JSON for prototype (polygon = array of {lat,lng}, circle = [center])
  coords            Json
  radiusMeters      Int? // for CIRCLE
  active            Boolean      @default(true)
  notifyAuthorities Boolean      @default(true)
  severity          Int          @default(1)
  createdById       String
  createdBy         Admin        @relation(fields: [createdById], references: [id])
  createdAt         DateTime     @default(now())

  alerts Alert[]
}

model Alert {
  id         String    @id @default(uuid())
  touristId  String
  tourist    Tourist   @relation(fields: [touristId], references: [id])
  geoFenceId String?
  geoFence   GeoFence? @relation(fields: [geoFenceId], references: [id])
  lat        Float
  lng        Float
  type       AlertType
  message    String?
  createdAt  DateTime  @default(now())
  resolved   Boolean   @default(false)

  @@index([touristId])
  @@index([geoFenceId])
  @@index([createdAt])
}

model TouristLocation {
  id        String   @id @default(uuid())
  touristId String   @unique
  tourist   Tourist  @relation(fields: [touristId], references: [id])
  lat       Float
  lng       Float
  accuracy  Float? // GPS accuracy in meters (optional)
  updatedAt DateTime @updatedAt

  @@index([touristId])
  @@index([updatedAt])
}
